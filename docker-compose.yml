services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: transcendence-frontend
    ports: ["${VITE_PORT}:${VITE_PORT}"]
    volumes:
      - ./frontend:/app
      - ./backend/certs/backend.pem:/certs/backend-ca.pem:ro
      - /app/node_modules
    environment:
      - VITE_PORT=${VITE_PORT}
      - VITE_HOST=${VITE_HOST}
      - VITE_ALLOWED_HOST_NAME=${VITE_ALLOWED_HOST_NAME}
      - VITE_LOCAL_BACKEND_URL=${DOCKER_BACKEND_URL}
      - NODE_EXTRA_CA_CERTS=/certs/backend-ca.pem
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks: [transcendence-network]

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: transcendence-backend
    expose: ["${BACKEND_PORT}"]
    volumes:
      - ./backend/src:/app/src
      - ./backend/prisma:/app/prisma
      - ./backend/uploads:/app/uploads
      - ./backend/certs:/app/certs:ro
      - /app/node_modules
    environment:
      - BACKEND_PORT=${BACKEND_PORT}
      - BACKEND_HOST=${BACKEND_HOST}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - COOKIE_SECRET=${COOKIE_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
    restart: unless-stopped
    networks: [transcendence-network]

networks:
  transcendence-network:
    driver: bridge
