// from docs: Data source: Specifies your database connection (via an environment variable)
// https://www.prisma.io/docs/orm/prisma-schema/overview/generators
generator client {
  provider = "prisma-client-js"
}

// from docs: Generator: Indicates that you want to generate Prisma Client
// https://www.prisma.io/docs/orm/prisma-schema/overview/data-sources
// https://www.prisma.io/docs/orm/overview/databases/sqlite
datasource db {
  provider = "sqlite"
  url      = "file:./data/pong.db"
}

// from docs: Data model: Defines your application models
// https://www.prisma.io/docs/orm/prisma-schema/data-model/models

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum UserStatus {
  ONLINE
  OFFLINE
}

enum AvatarType {
  DEFAULT
  CUSTOM
}

model User {
  id                  Int             @id @default(autoincrement())
  username            String          @unique
  displayName         String
  passwordHash        String
  isTwoFAenabled      Boolean         @default(false)
  twoFAsecret         String?
  tokenHash           String?
  tokenExpiresAt      DateTime?
  tokenRevoked        Boolean         @default(false)

  avatarURL           String          @default("/uploads/avatars/default.png")
  avatarType          AvatarType      @default(DEFAULT)

  status              UserStatus      @default(OFFLINE)
  updatedAt           DateTime        @updatedAt
  createdAt           DateTime        @default(now())
  isDeleted           Boolean         @default(false)

  // --- Other relations
  matchesWon          Match[]         @relation("MatchWinner")
  matchParticipants   MatchParticipant[]
  friendsAsUser       Friend[]        @relation("Friends_user")
  friendsAsFriend     Friend[]        @relation("Friends_friend")

  @@index([username])
}

model Friend {
  id        Int      @id @default(autoincrement())
  userID    Int
  friendID  Int
  status    FriendStatus
  createdAt DateTime @default(now())

  user      User     @relation("Friends_user",   fields: [userID],   references: [id], onDelete: Cascade)
  friend    User     @relation("Friends_friend", fields: [friendID], references: [id], onDelete: Cascade)

  @@unique([userID, friendID])
  @@index([friendID])
}

model Match {
  id            Int        @id @default(autoincrement())
  winnerId      Int?
  createdAt     DateTime?

  winner        User?       @relation("MatchWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  participants  MatchParticipant[]

  @@index([winnerId])
}

model MatchParticipant {
  matchId    Int
  userId     Int
  score      Int        @default(0)
  isWinner   Boolean    @default(false)
  createdAt  DateTime?

  match      Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([matchId, userId])
  @@index([userId])
}
